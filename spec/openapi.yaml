openapi: 3.1.0
info:
  title: InspoBox API
  description: |
    çµæ„Ÿæ”¶é›†å™¨ - ä¸ªäººå°è¯´çµæ„Ÿæ”¶é›†ä¸ç®¡ç† API
    
    ## åŠŸèƒ½ç‰¹æ€§
    - âœ¨ çµæ„Ÿæ•æ‰ - å¿«é€Ÿè®°å½•åˆ›ä½œçµæ„Ÿ
    - ğŸ“š æ•…äº‹ç®¡ç† - æŒ‰æ•…äº‹ç»„ç»‡çµæ„Ÿç¢ç‰‡
    - ğŸ·ï¸ æ ‡ç­¾ç³»ç»Ÿ - å¤šç»´åº¦åˆ†ç±»
    - ğŸ¤– AI è¾…åŠ© - æ™ºèƒ½é‡ç»„ä¸åˆ›ä½œå»ºè®®
    - ğŸ‘¤ å¤šç”¨æˆ·æ”¯æŒ - æ•°æ®å®Œå…¨éš”ç¦»
    
  version: 1.0.0
  contact:
    name: InspoBox Team
servers:
  - url: http://localhost:3000/api
    description: æœ¬åœ°å¼€å‘ç¯å¢ƒ
  - url: https://inspobox.vercel.app/api
    description: ç”Ÿäº§ç¯å¢ƒ

security:
  - BearerAuth: []
  - CookieAuth: []

tags:
  - name: Authentication
    description: ç”¨æˆ·è®¤è¯ç›¸å…³
  - name: Fragments
    description: çµæ„Ÿç¢ç‰‡ç®¡ç†
  - name: Stories
    description: æ•…äº‹ç®¡ç†
  - name: Tags
    description: æ ‡ç­¾ç®¡ç†
  - name: AI
    description: AI åˆ†æä¸é‡ç»„
  - name: Search
    description: æœç´¢åŠŸèƒ½

paths:
  # ========== Authentication ==========
  /auth/signout:
    post:
      tags:
        - Authentication
      summary: ç”¨æˆ·ç™»å‡º
      description: æ¸…é™¤ç”¨æˆ·ä¼šè¯ï¼Œé€€å‡ºç™»å½•
      operationId: signOut
      responses:
        '200':
          description: ç™»å‡ºæˆåŠŸ
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
        '500':
          $ref: '#/components/responses/InternalError'

  # ========== AI Analysis ==========
  /analyze:
    post:
      tags:
        - AI
      summary: AI çµæ„Ÿé‡ç»„åˆ†æ
      description: |
        ä½¿ç”¨é˜¿é‡Œäº‘é€šä¹‰åƒé—® AI å¯¹é€‰ä¸­çš„çµæ„Ÿç¢ç‰‡è¿›è¡Œæ™ºèƒ½åˆ†æï¼Œ
        å‘ç°ç¢ç‰‡ä¹‹é—´çš„å…³è”å…³ç³»ï¼Œå¹¶æä¾›åˆ›ä½œå»ºè®®ã€‚
        
        é‡‡ç”¨æµå¼å“åº” (SSE) è¿”å›åˆ†æç»“æœã€‚
      operationId: analyzeFragments
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AIAnalyzeRequest'
      responses:
        '200':
          description: æµå¼åˆ†æç»“æœ
          content:
            text/event-stream:
              schema:
                type: string
                description: SSE æµå¼å“åº”ï¼Œæ ¼å¼ä¸º Vercel AI SDK åè®®
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  # ========== Fragments (Client-side via Supabase) ==========
  /fragments:
    get:
      tags:
        - Fragments
      summary: è·å–çµæ„Ÿç¢ç‰‡åˆ—è¡¨
      description: è·å–å½“å‰ç”¨æˆ·çš„æ‰€æœ‰çµæ„Ÿç¢ç‰‡ï¼Œæ”¯æŒæŒ‰æ•…äº‹å’Œæ ‡ç­¾ç­›é€‰
      operationId: getFragments
      parameters:
        - name: story_id
          in: query
          schema:
            type: string
          description: æŒ‰æ•…äº‹ ID ç­›é€‰
        - name: tag_id
          in: query
          schema:
            type: string
          description: æŒ‰æ ‡ç­¾ ID ç­›é€‰
        - name: sort_by
          in: query
          schema:
            type: string
            enum: [newest, oldest, random]
            default: newest
          description: æ’åºæ–¹å¼
      responses:
        '200':
          description: ç¢ç‰‡åˆ—è¡¨
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Fragment'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags:
        - Fragments
      summary: åˆ›å»ºçµæ„Ÿç¢ç‰‡
      description: åˆ›å»ºæ–°çš„çµæ„Ÿç¢ç‰‡ï¼Œå¯é€‰å…³è”æ•…äº‹å’Œæ ‡ç­¾
      operationId: createFragment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateFragmentRequest'
      responses:
        '201':
          description: åˆ›å»ºæˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Fragment'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /fragments/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      tags:
        - Fragments
      summary: è·å–å•ä¸ªç¢ç‰‡
      operationId: getFragment
      responses:
        '200':
          description: ç¢ç‰‡è¯¦æƒ…
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Fragment'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      tags:
        - Fragments
      summary: æ›´æ–°ç¢ç‰‡
      description: æ›´æ–°ç¢ç‰‡å†…å®¹æˆ–æ‰€å±æ•…äº‹
      operationId: updateFragment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateFragmentRequest'
      responses:
        '200':
          description: æ›´æ–°æˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Fragment'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags:
        - Fragments
      summary: åˆ é™¤ç¢ç‰‡
      operationId: deleteFragment
      responses:
        '204':
          description: åˆ é™¤æˆåŠŸ
        '404':
          $ref: '#/components/responses/NotFound'

  /fragments/batch-delete:
    post:
      tags:
        - Fragments
      summary: æ‰¹é‡åˆ é™¤ç¢ç‰‡
      operationId: deleteFragments
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                ids:
                  type: array
                  items:
                    type: string
                    format: uuid
                  minItems: 1
      responses:
        '204':
          description: åˆ é™¤æˆåŠŸ

  /fragments/batch-update:
    post:
      tags:
        - Fragments
      summary: æ‰¹é‡æ›´æ–°ç¢ç‰‡
      description: æ‰¹é‡ç§»åŠ¨ç¢ç‰‡åˆ°æŒ‡å®šæ•…äº‹æˆ–æ·»åŠ /ç§»é™¤æ ‡ç­¾
      operationId: batchUpdateFragments
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BatchUpdateFragmentsRequest'
      responses:
        '200':
          description: æ›´æ–°æˆåŠŸ
          content:
            application/json:
              schema:
                type: object
                properties:
                  updated:
                    type: integer
                    description: æ›´æ–°çš„ç¢ç‰‡æ•°é‡
                  failed:
                    type: integer
                    description: å¤±è´¥çš„ç¢ç‰‡æ•°é‡
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /fragments/{id}/tags:
    post:
      tags:
        - Fragments
        - Tags
      summary: ä¸ºç¢ç‰‡æ·»åŠ æ ‡ç­¾
      operationId: addTagToFragment
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                tag_id:
                  type: string
                  format: uuid
              required: [tag_id]
      responses:
        '201':
          description: æ·»åŠ æˆåŠŸ

    delete:
      tags:
        - Fragments
        - Tags
      summary: ç§»é™¤ç¢ç‰‡æ ‡ç­¾
      operationId: removeTagFromFragment
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: tag_id
          in: query
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: ç§»é™¤æˆåŠŸ

  # ========== Stories ==========
  /stories:
    get:
      tags:
        - Stories
      summary: è·å–æ•…äº‹åˆ—è¡¨
      operationId: getStories
      responses:
        '200':
          description: æ•…äº‹åˆ—è¡¨
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Story'

    post:
      tags:
        - Stories
      summary: åˆ›å»ºæ•…äº‹
      operationId: createStory
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateStoryRequest'
      responses:
        '201':
          description: åˆ›å»ºæˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Story'

  /stories/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      tags:
        - Stories
      summary: è·å–æ•…äº‹è¯¦æƒ…
      operationId: getStory
      responses:
        '200':
          description: æ•…äº‹è¯¦æƒ…
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Story'

    patch:
      tags:
        - Stories
      summary: æ›´æ–°æ•…äº‹
      operationId: updateStory
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateStoryRequest'
      responses:
        '200':
          description: æ›´æ–°æˆåŠŸ

    delete:
      tags:
        - Stories
      summary: åˆ é™¤æ•…äº‹
      operationId: deleteStory
      responses:
        '204':
          description: åˆ é™¤æˆåŠŸ

  # ========== Tags ==========
  /tags:
    get:
      tags:
        - Tags
      summary: è·å–æ ‡ç­¾åˆ—è¡¨
      operationId: getTags
      responses:
        '200':
          description: æ ‡ç­¾åˆ—è¡¨
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Tag'

    post:
      tags:
        - Tags
      summary: åˆ›å»ºæ ‡ç­¾
      operationId: createTag
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTagRequest'
      responses:
        '201':
          description: åˆ›å»ºæˆåŠŸ

  /tags/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid

    delete:
      tags:
        - Tags
      summary: åˆ é™¤æ ‡ç­¾
      operationId: deleteTag
      responses:
        '204':
          description: åˆ é™¤æˆåŠŸ

  # ========== Search ==========
  /search:
    get:
      tags:
        - Search
      summary: æœç´¢çµæ„Ÿç¢ç‰‡
      description: |
        å…¨æ–‡æœç´¢çµæ„Ÿç¢ç‰‡ï¼Œæ”¯æŒæŒ‰å†…å®¹ã€æ•…äº‹åã€æ ‡ç­¾åæœç´¢ã€‚
        ç»“æœæŒ‰ç›¸å…³æ€§å’Œæ—¶é—´æ’åºã€‚
      operationId: searchFragments
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
            minLength: 1
            maxLength: 200
          description: æœç´¢å…³é”®è¯
        - name: story_id
          in: query
          schema:
            type: string
          description: é™åˆ¶æœç´¢èŒƒå›´åˆ°æŒ‡å®šæ•…äº‹
        - name: tag_ids
          in: query
          schema:
            type: array
            items:
              type: string
          description: é™åˆ¶æœç´¢èŒƒå›´åˆ°æŒ‡å®šæ ‡ç­¾
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
          description: è¿”å›ç»“æœæ•°é‡
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
          description: åˆ†é¡µåç§»é‡
      responses:
        '200':
          description: æœç´¢ç»“æœ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /search/suggestions:
    get:
      tags:
        - Search
      summary: è·å–æœç´¢å»ºè®®
      description: æ ¹æ®è¾“å…¥å†…å®¹è¿”å›æœç´¢å»ºè®®ï¼ˆæ ‡ç­¾ã€æ•…äº‹ï¼‰
      operationId: getSearchSuggestions
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
            minLength: 1
            maxLength: 50
          description: æœç´¢å‰ç¼€
      responses:
        '200':
          description: æœç´¢å»ºè®®
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchSuggestions'

  # ========== AI History ==========
  /ai-history:
    get:
      tags:
        - AI
      summary: è·å– AI åˆ†æå†å²
      operationId: getAIHistory
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
      responses:
        '200':
          description: å†å²è®°å½•åˆ—è¡¨
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AIAnalysisHistory'

  # ========== Fragment Relations ==========
  /relations/analyze:
    post:
      tags:
        - Relations
      summary: AI åˆ†æç¢ç‰‡å…³è”
      description: ä½¿ç”¨ AI åˆ†æç¢ç‰‡ä¹‹é—´çš„æ½œåœ¨å…³è”å…³ç³»
      operationId: analyzeRelations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RelationAnalyzeRequest'
      responses:
        '200':
          description: å…³è”åˆ†æç»“æœ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RelationAnalyzeResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /relations/suggestions:
    get:
      tags:
        - Relations
      summary: è·å–å…³è”æ¨è
      description: è·å– AI æ¨èçš„ç¢ç‰‡å…³è”å»ºè®®
      operationId: getRelationSuggestions
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
            maximum: 50
      responses:
        '200':
          description: å…³è”æ¨èåˆ—è¡¨
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RelationSuggestions'

  /relations:
    get:
      tags:
        - Relations
      summary: è·å–æ‰€æœ‰å…³è”
      description: è·å–ç”¨æˆ·ç¡®è®¤çš„æ‰€æœ‰ç¢ç‰‡å…³è”
      operationId: getRelations
      responses:
        '200':
          description: å…³è”åˆ—è¡¨
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/FragmentRelation'

    post:
      tags:
        - Relations
      summary: åˆ›å»ºå…³è”
      description: æ‰‹åŠ¨åˆ›å»ºç¢ç‰‡ä¹‹é—´çš„å…³è”
      operationId: createRelation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRelationRequest'
      responses:
        '201':
          description: åˆ›å»ºæˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FragmentRelation'

  /relations/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid

    delete:
      tags:
        - Relations
      summary: åˆ é™¤å…³è”
      operationId: deleteRelation
      responses:
        '204':
          description: åˆ é™¤æˆåŠŸ

  /relations/suggestions/{id}/accept:
    post:
      tags:
        - Relations
      summary: æ¥å—å…³è”æ¨è
      description: å°† AI æ¨èçš„å…³è”è½¬ä¸ºæ­£å¼å…³è”
      operationId: acceptRelationSuggestion
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: æ¥å—æˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FragmentRelation'

  /relations/suggestions/{id}/reject:
    post:
      tags:
        - Relations
      summary: æ‹’ç»å…³è”æ¨è
      description: æ‹’ç» AI æ¨èçš„å…³è”
      operationId: rejectRelationSuggestion
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: æ‹’ç»æˆåŠŸ

  /relations/groups:
    get:
      tags:
        - Relations
      summary: è·å–æ™ºèƒ½åˆ†ç»„
      description: AI è‡ªåŠ¨åˆ†ç»„çš„å»ºè®®
      operationId: getSmartGroups
      responses:
        '200':
          description: åˆ†ç»„åˆ—è¡¨
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/SmartGroup'

  /relations/timeline:
    get:
      tags:
        - Relations
      summary: è·å–å™äº‹æ—¶é—´çº¿
      description: AI åˆ†æçš„å™äº‹æ—¶é—´çº¿
      operationId: getTimeline
      responses:
        '200':
          description: æ—¶é—´çº¿æ•°æ®
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TimelineData'

  /relations/themes:
    get:
      tags:
        - Relations
      summary: è·å–ä¸»é¢˜èšç±»
      description: AI æå–çš„ä¸»é¢˜èšç±»
      operationId: getThemeClusters
      responses:
        '200':
          description: ä¸»é¢˜èšç±»åˆ—è¡¨
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ThemeCluster'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      description: Supabase JWT Token
    CookieAuth:
      type: apiKey
      in: cookie
      name: sb-access-token

  schemas:
    # ========== Core Entities ==========
    Fragment:
      type: object
      required:
        - id
        - content
        - user_id
        - sort_order
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          description: ç¢ç‰‡å”¯ä¸€æ ‡è¯†
        content:
          type: string
          minLength: 1
          maxLength: 10000
          description: çµæ„Ÿå†…å®¹
        story_id:
          type: string
          format: uuid
          nullable: true
          description: æ‰€å±æ•…äº‹ ID
        story:
          $ref: '#/components/schemas/Story'
          description: å…³è”çš„æ•…äº‹ä¿¡æ¯
        tags:
          type: array
          items:
            $ref: '#/components/schemas/Tag'
          description: å…³è”çš„æ ‡ç­¾åˆ—è¡¨
        user_id:
          type: string
          format: uuid
          description: åˆ›å»ºè€… ID
        sort_order:
          type: integer
          default: 0
          description: æ’åºæƒé‡
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Story:
      type: object
      required:
        - id
        - title
        - color
        - user_id
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
          minLength: 1
          maxLength: 100
        description:
          type: string
          maxLength: 500
          nullable: true
        color:
          type: string
          pattern: '^#[0-9a-fA-F]{6}$'
          description: æ•…äº‹ä¸»é¢˜è‰²ï¼ˆåå…­è¿›åˆ¶ï¼‰
          example: "#3b82f6"
        user_id:
          type: string
          format: uuid
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Tag:
      type: object
      required:
        - id
        - name
        - color
        - user_id
        - created_at
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          minLength: 1
          maxLength: 50
          description: æ ‡ç­¾åç§°ï¼ˆå”¯ä¸€ï¼‰
        color:
          type: string
          pattern: '^#[0-9a-fA-F]{6}$'
          description: æ ‡ç­¾é¢œè‰²
          example: "#10b981"
        user_id:
          type: string
          format: uuid
        created_at:
          type: string
          format: date-time

    # ========== AI Related ==========
    AIAnalyzeRequest:
      type: object
      required:
        - fragments
        - targetFragment
      properties:
        fragments:
          type: array
          minItems: 1
          maxItems: 50
          items:
            type: object
            required:
              - id
              - content
            properties:
              id:
                type: string
                format: uuid
              content:
                type: string
        targetFragment:
          type: object
          required:
            - id
            - content
          properties:
            id:
              type: string
              format: uuid
            content:
              type: string

    AIAnalysisResult:
      type: object
      required:
        - groups
        - suggestions
      properties:
        groups:
          type: array
          items:
            $ref: '#/components/schemas/AIGroup'
        suggestions:
          type: array
          items:
            type: string
          minItems: 1
          maxItems: 5
          description: AI æä¾›çš„åˆ›ä½œå»ºè®®

    AIGroup:
      type: object
      required:
        - label
        - fragmentIds
      properties:
        label:
          type: string
          description: æœ‰æ•…äº‹æ„Ÿçš„çº¿ç´¢åç§°
          example: "è¢«æŠ˜å çš„åˆå"
        fragmentIds:
          type: array
          items:
            type: string
            format: uuid

    AIAnalysisHistory:
      type: object
      required:
        - id
        - fragment_ids
        - result
        - user_id
        - created_at
      properties:
        id:
          type: string
          format: uuid
        fragment_ids:
          type: array
          items:
            type: string
            format: uuid
        target_fragment_id:
          type: string
          format: uuid
          nullable: true
        result:
          $ref: '#/components/schemas/AIAnalysisResult'
        raw_text:
          type: string
          nullable: true
          description: AI åŸå§‹å“åº”æ–‡æœ¬
        user_id:
          type: string
          format: uuid
        created_at:
          type: string
          format: date-time

    # ========== Search Related ==========
    SearchResult:
      type: object
      required:
        - fragments
        - total
        - query
      properties:
        fragments:
          type: array
          items:
            $ref: '#/components/schemas/Fragment'
        total:
          type: integer
          description: æ€»ç»“æœæ•°
        query:
          type: string
          description: æœç´¢å…³é”®è¯
        has_more:
          type: boolean
          description: æ˜¯å¦æœ‰æ›´å¤šç»“æœ

    SearchSuggestions:
      type: object
      required:
        - stories
        - tags
      properties:
        stories:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              title:
                type: string
              color:
                type: string
        tags:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              name:
                type: string
              color:
                type: string

    # ========== Request Bodies ==========
    CreateFragmentRequest:
      type: object
      required:
        - content
      properties:
        content:
          type: string
          minLength: 1
          maxLength: 10000
        story_id:
          type: string
          format: uuid
          nullable: true
        tag_ids:
          type: array
          items:
            type: string
            format: uuid

    UpdateFragmentRequest:
      type: object
      properties:
        content:
          type: string
          minLength: 1
          maxLength: 10000
        story_id:
          type: string
          format: uuid
          nullable: true
        sort_order:
          type: integer

    CreateStoryRequest:
      type: object
      required:
        - title
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 100
        description:
          type: string
          maxLength: 500
        color:
          type: string
          pattern: '^#[0-9a-fA-F]{6}$'
          default: "#171717"

    UpdateStoryRequest:
      type: object
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 100
        description:
          type: string
          maxLength: 500
        color:
          type: string
          pattern: '^#[0-9a-fA-F]{6}$'

    CreateTagRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 50
        color:
          type: string
          pattern: '^#[0-9a-fA-F]{6}$'
          default: "#6b7280"

    BatchUpdateFragmentsRequest:
      type: object
      required:
        - ids
        - action
      properties:
        ids:
          type: array
          items:
            type: string
            format: uuid
          minItems: 1
          maxItems: 100
          description: è¦æ›´æ–°çš„ç¢ç‰‡ ID åˆ—è¡¨
        action:
          type: string
          enum: [move_to_story, add_tags, remove_tags]
          description: æ‰¹é‡æ“ä½œç±»å‹
        story_id:
          type: string
          format: uuid
          nullable: true
          description: ç›®æ ‡æ•…äº‹ IDï¼ˆaction ä¸º move_to_story æ—¶å¿…å¡«ï¼‰
        tag_ids:
          type: array
          items:
            type: string
            format: uuid
          description: è¦æ·»åŠ /ç§»é™¤çš„æ ‡ç­¾ ID åˆ—è¡¨ï¼ˆaction ä¸º add_tags/remove_tags æ—¶å¿…å¡«ï¼‰

    # ========== Relation Schemas ==========
    FragmentRelation:
      type: object
      required:
        - id
        - source_fragment_id
        - target_fragment_id
        - relation_type
        - user_id
        - created_at
      properties:
        id:
          type: string
          format: uuid
        source_fragment_id:
          type: string
          format: uuid
          description: æºç¢ç‰‡ ID
        target_fragment_id:
          type: string
          format: uuid
          description: ç›®æ ‡ç¢ç‰‡ ID
        relation_type:
          type: string
          enum: [similar, contrast, sequence, causal, thematic, emotional, reference, custom]
          description: å…³è”ç±»å‹
        strength:
          type: number
          minimum: 0
          maximum: 1
          description: å…³è”å¼ºåº¦ 0-1
        description:
          type: string
          description: å…³è”æè¿°
        ai_generated:
          type: boolean
          description: æ˜¯å¦ç”± AI ç”Ÿæˆ
        ai_confidence:
          type: number
          minimum: 0
          maximum: 1
          description: AI ç½®ä¿¡åº¦
        user_id:
          type: string
          format: uuid
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateRelationRequest:
      type: object
      required:
        - source_fragment_id
        - target_fragment_id
        - relation_type
      properties:
        source_fragment_id:
          type: string
          format: uuid
        target_fragment_id:
          type: string
          format: uuid
        relation_type:
          type: string
          enum: [similar, contrast, sequence, causal, thematic, emotional, reference, custom]
        strength:
          type: number
          minimum: 0
          maximum: 1
        description:
          type: string

    RelationAnalyzeRequest:
      type: object
      required:
        - fragment_ids
      properties:
        fragment_ids:
          type: array
          items:
            type: string
            format: uuid
          minItems: 2
          maxItems: 50
          description: è¦åˆ†æçš„ç¢ç‰‡ ID åˆ—è¡¨
        analysis_depth:
          type: string
          enum: [basic, deep]
          default: basic
          description: åˆ†ææ·±åº¦

    RelationAnalyzeResult:
      type: object
      required:
        - relations
        - groups
        - timeline
        - themes
      properties:
        relations:
          type: array
          items:
            $ref: '#/components/schemas/FragmentRelation'
        groups:
          type: array
          items:
            $ref: '#/components/schemas/SmartGroup'
        timeline:
          $ref: '#/components/schemas/TimelineData'
        themes:
          type: array
          items:
            $ref: '#/components/schemas/ThemeCluster'
        suggestions:
          type: array
          items:
            $ref: '#/components/schemas/RelationSuggestion'

    RelationSuggestion:
      type: object
      required:
        - id
        - source_fragment_id
        - target_fragment_id
        - relation_type
        - confidence
      properties:
        id:
          type: string
        source_fragment_id:
          type: string
          format: uuid
        target_fragment_id:
          type: string
          format: uuid
        source_fragment:
          type: object
          properties:
            id:
              type: string
            content:
              type: string
        target_fragment:
          type: object
          properties:
            id:
              type: string
            content:
              type: string
        relation_type:
          type: string
          enum: [similar, contrast, sequence, causal, thematic, emotional, reference]
        confidence:
          type: number
          minimum: 0
          maximum: 1
        reason:
          type: string
          description: AI æ¨èç†ç”±
        status:
          type: string
          enum: [pending, accepted, rejected]

    RelationSuggestions:
      type: object
      required:
        - suggestions
        - total_pending
      properties:
        suggestions:
          type: array
          items:
            $ref: '#/components/schemas/RelationSuggestion'
        total_pending:
          type: integer
          description: å¾…å¤„ç†çš„æ¨èæ•°é‡

    SmartGroup:
      type: object
      required:
        - id
        - name
        - fragment_ids
      properties:
        id:
          type: string
        name:
          type: string
          description: AI ç”Ÿæˆçš„ç»„å
        description:
          type: string
          description: ç»„çš„æè¿°
        fragment_ids:
          type: array
          items:
            type: string
            format: uuid
        tags:
          type: array
          items:
            type: string
          description: ç»„çš„ä¸»é¢˜æ ‡ç­¾
        color:
          type: string
          description: ç»„çš„é¢œè‰²
        confidence:
          type: number
          minimum: 0
          maximum: 1
        key_themes:
          type: array
          items:
            type: string

    TimelineData:
      type: object
      required:
        - events
        - gaps
      properties:
        events:
          type: array
          items:
            type: object
            properties:
              fragment_id:
                type: string
                format: uuid
              position:
                type: number
              estimated_time:
                type: string
                nullable: true
              narrative_role:
                type: string
                enum: [setup, inciting, rising, climax, falling, resolution]
              connections:
                type: object
                properties:
                  before:
                    type: array
                    items:
                      type: string
                  after:
                    type: array
                    items:
                      type: string
        gaps:
          type: array
          items:
            type: object
            properties:
              after_fragment_id:
                type: string
              before_fragment_id:
                type: string
              description:
                type: string
              suggestion:
                type: string

    ThemeCluster:
      type: object
      required:
        - id
        - name
        - keywords
        - fragment_ids
      properties:
        id:
          type: string
        name:
          type: string
        level:
          type: string
          enum: [primary, secondary, tertiary]
        keywords:
          type: array
          items:
            type: string
        fragment_ids:
          type: array
          items:
            type: string
            format: uuid
        related_themes:
          type: array
          items:
            type: string
        heat_score:
          type: number
          description: çƒ­åº¦åˆ†æ•°ï¼ˆç¢ç‰‡æ•°é‡ï¼‰

    # ========== Error Schemas ==========
    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: string
        message:
          type: string
        code:
          type: string

  responses:
    BadRequest:
      description: è¯·æ±‚å‚æ•°é”™è¯¯
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Bad Request"
            message: "Content is required"
            code: "VALIDATION_ERROR"

    Unauthorized:
      description: æœªæˆæƒï¼Œéœ€è¦ç™»å½•
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Unauthorized"
            message: "Authentication required"
            code: "AUTH_REQUIRED"

    NotFound:
      description: èµ„æºä¸å­˜åœ¨
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Not Found"
            message: "Fragment not found"
            code: "RESOURCE_NOT_FOUND"

    InternalError:
      description: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Internal Server Error"
            message: "Something went wrong"
            code: "INTERNAL_ERROR"
